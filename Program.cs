using Microsoft.Win32;
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace RemoveFakeValyseMalware
{
    internal class Program
    {

        static void DisinfectDiscord()
        {
            Console.WriteLine("Disinfecting Discord");
            string discordPath = Environment.GetFolderPath(Environment.SpecialFolder.LocalApplicationData) + "\\Discord\\";
            foreach (string folder in Directory.GetDirectories(discordPath))
            {
                if (!folder.Split('\\').Last().StartsWith("app"))
                {
                    continue;
                }
                string core = "";
                foreach (string f in Directory.GetDirectories(folder + "\\modules\\"))
                {
                    if (f.Split('\\').Last().StartsWith("discord_desktop"))
                        core = f;
                }
                core = Directory.GetDirectories(core)[0] + "\\index.js";
                Console.WriteLine("Disinfecting " + folder);
                File.WriteAllText(core, "module.exports = require('./core.asar');");
            }

            Console.WriteLine("Disinfected Discord, restarting");
            Process[] processes = Process.GetProcessesByName("Discord");
            foreach (Process process in processes)
            {
                process.Kill();
            }

            Process.Start(discordPath + "Update.exe", "--processStart Discord.exe");

        }
        static void RemoveFile(string path)
        {
            string fileName = path.Split('\\').Last();
            if (fileName.EndsWith(".exe"))
            {
                Process[] processes = Process.GetProcessesByName(fileName.Replace(".exe", ""));
                foreach (Process process in processes)
                {
                    Console.WriteLine("Killing process " + process.ProcessName);
                    process.Kill();
                }
            }
            try
            {
                File.Delete(path);  
            }catch (Exception)
            {
              ;
            }
        }

        static void Main(string[] args)
        {

            Console.Clear();
            Console.WriteLine("Remove Fake Valyse Malware - https://github.com/BodyAlhoha");
            Console.Title = "RFVM";

            // check if DDP host is in HKCU runOnce
            RegistryKey runOnce = Registry.CurrentUser.OpenSubKey(@"Software\Microsoft\Windows\CurrentVersion\Run", true);


            bool installed = false;

            if (runOnce != null)
            {

                if (runOnce.GetValue("DDP Host") != null)
                {
                    installed = true;
                }
            }


            if (!installed)
            {
                Console.WriteLine("You do not seem to be infected, press any key to exit");
                Console.ReadKey();
                return;
            }

            string path = runOnce.GetValue("DDP Host").ToString();
            
            Console.WriteLine("NanoCore stub found, removing...");
            runOnce.DeleteValue("DDP Host");
            RemoveFile(path);
            Console.WriteLine("Removed NanoCore");

            if (runOnce.GetValue("empyrean") != null)
            {
                string empPath = runOnce.GetValue("empyrean").ToString();
                RemoveFile(empPath);
                runOnce.DeleteValue("empyrean");
                Console.WriteLine("Removed empyrean");
            }

            string temp = Environment.GetFolderPath(Environment.SpecialFolder.LocalApplicationData) + "\\Temp\\";
            RemoveFile(temp + "O.exe");
            RemoveFile(temp + "MAIN.exe");

            DisinfectDiscord();


            Console.WriteLine("Disinfected successfully, please reset all your passwords! Press any key to exit.");
            Console.ReadKey();


        }
    }
}
